name: Build Unsigned IPA

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: ["main", "master"]
    paths:
      - 'lib/**'
      - 'ios/**'
      - 'rust/**'
      - 'pubspec.yaml'
      - '.github/workflows/build_ipa.yml'

jobs:
  build-ipa:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. é…ç½® Rust ç¯å¢ƒ
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. é…ç½® Flutter ç¯å¢ƒ (ä½¿ç”¨ master æ¸ é“ä»¥å…¼å®¹ä½ æœ¬åœ° Dart ç‰ˆæœ¬)
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'master'
          cache: true

      # 3. ç°åœºç¼–è¯‘ Rust å¹¶æ”¾å…¥æŒ‡å®šç›®å½•
      - name: Build and Place Rust Lib
        run: |
          echo "ğŸ› ï¸ Compiling Rust for iOS..."
          cd rust
          # ç¼–è¯‘çœŸæœºæ¶æ„ (arm64)
          cargo build --release --target aarch64-apple-ios
          cd ..
          
          echo "ğŸ“‚ Moving lib to ios/Libs..."
          mkdir -p ios/Libs
          # å¤åˆ¶ç”Ÿæˆçš„ .a æ–‡ä»¶åˆ° ios/Libs
          cp rust/target/aarch64-apple-ios/release/libnovella_native.a ios/Libs/
          
          echo "âœ… Rust lib placed successfully!"

      # 4. è·å–ä¾èµ–
      - name: Flutter Pub Get
        run: flutter pub get

      # 5. [ä¿®æ­£] æ„å»ºå…ç­¾ Release åŒ…
      # å»æ‰äº†é”™è¯¯çš„ --extensions å‚æ•°
      # ä¿ç•™äº† --xcargs ä»¥å¼ºè¡Œè¦†ç›– Xcode çš„ç­¾åæ£€æŸ¥
      - name: Build iOS Release (No Codesign)
        run: >
          flutter build ios --release --no-codesign
          --xcargs="CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGN_IDENTITY='' CODE_SIGN_ENTITLEMENTS='' CODE_SIGNING_STYLE=Manual PROVISIONING_PROFILE_SPECIFIER=''"

      # 6. æ‰“åŒ…æˆ IPA
      - name: Package IPA
        run: |
          mkdir Payload
          # å°† Runner.app æ”¾å…¥ Payload æ–‡ä»¶å¤¹
          mv build/ios/iphoneos/Runner.app Payload
          # å‹ç¼©ä¸º ipa
          zip -r novella.ipa Payload

      # 7. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: novella-unsigned-ipa
          path: novella.ipa
