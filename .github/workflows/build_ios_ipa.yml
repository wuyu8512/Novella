name: Build Unsigned IPA

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  push:
    branches: ["main", "master"]
    paths:
      - 'lib/**'
      - 'ios/**'
      - 'rust/**'
      - 'pubspec.yaml'
      - '.github/workflows/build_ipa.yml'

jobs:
  build-ipa:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. é…ç½® Rust ç¯å¢ƒ (ç¼–è¯‘é™æ€åº“å¿…é¡»)
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # 2. é…ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.1' # æˆ–ä½¿ç”¨ 'stable'
          channel: 'stable'
          cache: true

      # 3. [å…³é”®] ç°åœºç¼–è¯‘ Rust å¹¶æ”¾å…¥æŒ‡å®šç›®å½•
      # æ»¡è¶³åœ¨ .xcconfig é‡Œé…ç½®çš„ -force_load è·¯å¾„
      - name: Build and Place Rust Lib
        run: |
          echo "ğŸ› ï¸ Compiling Rust for iOS..."
          cd rust
          # ç¼–è¯‘çœŸæœºæ¶æ„ (arm64)
          cargo build --release --target aarch64-apple-ios
          cd ..
          
          echo "ğŸ“‚ Moving lib to ios/Libs..."
          mkdir -p ios/Libs
          # å¤åˆ¶ç”Ÿæˆçš„ .a æ–‡ä»¶åˆ° ios/Libsï¼Œä¾› Xcode é“¾æ¥
          cp rust/target/aarch64-apple-ios/release/libnovella_native.a ios/Libs/
          
          echo "âœ… Rust lib placed successfully!"

      # 4. è·å–ä¾èµ–
      - name: Flutter Pub Get
        run: flutter pub get

      # 5. æ„å»ºå…ç­¾ Release åŒ…
      - name: Build iOS Release (No Codesign)
        run: flutter build ios --release --no-codesign

      # 6. æ‰“åŒ…æˆ IPA
      - name: Package IPA
        run: |
          mkdir Payload
          # å°† Runner.app æ”¾å…¥ Payload æ–‡ä»¶å¤¹
          mv build/ios/iphoneos/Runner.app Payload
          # å‹ç¼©ä¸º ipa
          zip -r novella.ipa Payload

      # 7. ä¸Šä¼ äº§ç‰©
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: novella-unsigned-ipa
          path: novella.ipa